<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claim Processing Results - OCR Claim Assessment</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <a href="{{ url_for('index') }}" class="logo">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    OCR Claim Assessment
                </a>
                <nav>
                    <ul class="nav-links">
                        <li><a href="{{ url_for('index') }}">New Claim</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="page-title">
                <h1>Claim Processing Results</h1>
                <p class="page-subtitle">
                    Document processed successfully. Review the results below.
                </p>
            </div>

            {% if claim %}
            <!-- Main Result Card -->
            <div class="claim-result {{ claim.claim_status }}">
                <div class="claim-header">
                    <div>
                        <h2>Claim Status</h2>
                        <div class="claim-status {{ claim.claim_status }}">
                            {% if claim.claim_status == 'approved' %}
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                APPROVED
                            {% elif claim.claim_status == 'rejected' %}
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="15" y1="9" x2="9" y2="15"/>
                                    <line x1="9" y1="9" x2="15" y2="15"/>
                                </svg>
                                REJECTED
                            {% else %}
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="m9 12 2 2 4-4"/>
                                </svg>
                                REVIEW REQUIRED
                            {% endif %}
                        </div>
                    </div>
                    <div class="claim-meta">
                        <div class="text-sm text-secondary">
                            Processed: {{ claim.created_at[:19] if claim.created_at else 'Unknown' }}
                        </div>
                        {% if claim.metadata and claim.metadata.processing_time_ms %}
                        <div class="text-sm text-secondary">
                            Processing Time: {{ claim.metadata.processing_time_ms }}ms
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Claim Details Grid -->
                <div class="claim-details">
                    <div class="detail-item">
                        <div class="detail-label">Claim ID</div>
                        <div class="detail-value">{{ claim.id[:8] }}...</div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">File Name</div>
                        <div class="detail-value">{{ claim.file_name }}</div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">File Size</div>
                        <div class="detail-value">{{ "%.1f KB" | format(claim.file_size / 1024) if claim.file_size else 'Unknown' }}</div>
                    </div>
                    
                    {% if claim.claim_amount %}
                    <div class="detail-item">
                        <div class="detail-label">Claim Amount</div>
                        <div class="detail-value">
                            {% if claim.metadata and claim.metadata.currency %}
                                {{ claim.metadata.currency }}
                            {% else %}
                                SGD
                            {% endif %}
                            {{ "%.2f" | format(claim.claim_amount) }}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if claim.language_detected %}
                    <div class="detail-item">
                        <div class="detail-label">Language Detected</div>
                        <div class="detail-value">
                            {{ languages.get(claim.language_detected, claim.language_detected.title()) }}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if claim.confidence_score is not none %}
                    <div class="detail-item">
                        <div class="detail-label">Confidence Score</div>
                        <div class="detail-value">
                            <div class="confidence-score">
                                <div class="confidence-bar">
                                    <div class="confidence-fill {{ 'high' if claim.confidence_score > 0.8 else 'medium' if claim.confidence_score > 0.5 else 'low' }}" 
                                         style="width: {{ (claim.confidence_score * 100) | round }}%"></div>
                                </div>
                                <div class="confidence-text">{{ (claim.confidence_score * 100) | round }}%</div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Processing Notes -->
                {% if claim.metadata and (claim.metadata.decision_reasons or claim.metadata.processing_notes) %}
                <div class="mt-6">
                    <h3 class="mb-3">Processing Summary</h3>
                    
                    {% if claim.metadata.decision_reasons %}
                    <div class="mb-4">
                        <h4 class="mb-2">Decision Reasons:</h4>
                        <ul class="list-disc list-inside">
                            {% for reason in claim.metadata.decision_reasons %}
                            <li class="text-sm">{{ reason }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    {% if claim.metadata.processing_notes %}
                    <div class="alert alert-info">
                        {{ claim.metadata.processing_notes }}
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <!-- Extracted Text Display -->
            {% if claim.ocr_text %}
            <div class="extracted-text">
                <div class="extracted-text-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <path d="m14,2 l6,6"/>
                        <path d="m16,13 l-8,0"/>
                        <path d="m16,17 l-8,0"/>
                        <path d="m10,9 l0,0"/>
                    </svg>
                    Extracted Text
                    <button class="btn btn-sm btn-secondary" onclick="copyText()" id="copyBtn">
                        Copy Text
                    </button>
                </div>
                <div class="extracted-text-content" id="extractedText">{{ claim.ocr_text }}</div>
            </div>
            {% endif %}

            <!-- OCR Processing Details -->
            {% if ocr %}
            <div class="card">
                <div class="card-header">
                    <h3>OCR Processing Details</h3>
                </div>
                <div class="card-body">
                    <div class="claim-details">
                        {% if ocr.language_code %}
                        <div class="detail-item">
                            <div class="detail-label">Languages Processed</div>
                            <div class="detail-value">{{ ocr.language_code }}</div>
                        </div>
                        {% endif %}
                        
                        {% if ocr.processing_engine %}
                        <div class="detail-item">
                            <div class="detail-label">Processing Engine</div>
                            <div class="detail-value">{{ ocr.processing_engine.title() }}</div>
                        </div>
                        {% endif %}
                        
                        {% if ocr.confidence_score is not none %}
                        <div class="detail-item">
                            <div class="detail-label">OCR Confidence</div>
                            <div class="detail-value">
                                <div class="confidence-score">
                                    <div class="confidence-bar">
                                        <div class="confidence-fill {{ 'high' if ocr.confidence_score > 0.8 else 'medium' if ocr.confidence_score > 0.5 else 'low' }}" 
                                             style="width: {{ (ocr.confidence_score * 100) | round }}%"></div>
                                    </div>
                                    <div class="confidence-text">{{ (ocr.confidence_score * 100) | round }}%</div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="detail-item">
                            <div class="detail-label">Processing Date</div>
                            <div class="detail-value">{{ ocr.created_at[:19] if ocr.created_at else 'Unknown' }}</div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Extracted Claim Data -->
            {% if claim.metadata and claim.metadata.extracted_data %}
            {% set extracted = claim.metadata.extracted_data %}
            {% if extracted.patient_name or extracted.provider_name or extracted.diagnosis_codes or extracted.treatment_dates %}
            <div class="card">
                <div class="card-header">
                    <h3>Extracted Claim Information</h3>
                </div>
                <div class="card-body">
                    <div class="claim-details">
                        {% if extracted.patient_name %}
                        <div class="detail-item">
                            <div class="detail-label">Patient Name</div>
                            <div class="detail-value">{{ extracted.patient_name }}</div>
                        </div>
                        {% endif %}
                        
                        {% if extracted.patient_id %}
                        <div class="detail-item">
                            <div class="detail-label">Patient ID</div>
                            <div class="detail-value">{{ extracted.patient_id }}</div>
                        </div>
                        {% endif %}
                        
                        {% if extracted.policy_number %}
                        <div class="detail-item">
                            <div class="detail-label">Policy Number</div>
                            <div class="detail-value">{{ extracted.policy_number }}</div>
                        </div>
                        {% endif %}
                        
                        {% if extracted.provider_name %}
                        <div class="detail-item">
                            <div class="detail-label">Healthcare Provider</div>
                            <div class="detail-value">{{ extracted.provider_name }}</div>
                        </div>
                        {% endif %}
                        
                        {% if extracted.diagnosis_codes %}
                        <div class="detail-item">
                            <div class="detail-label">Diagnosis Codes</div>
                            <div class="detail-value">{{ extracted.diagnosis_codes | join(', ') }}</div>
                        </div>
                        {% endif %}
                        
                        {% if extracted.treatment_dates %}
                        <div class="detail-item">
                            <div class="detail-label">Treatment Dates</div>
                            <div class="detail-value">{{ extracted.treatment_dates | join(', ') }}</div>
                        </div>
                        {% endif %}
                        
                        {% if extracted.amounts %}
                        <div class="detail-item">
                            <div class="detail-label">Detected Amounts</div>
                            <div class="detail-value">
                                {% for amount in extracted.amounts %}
                                    {{ extracted.currency or 'SGD' }} {{ "%.2f" | format(amount) }}
                                    {% if not loop.last %}, {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            {% endif %}

            <!-- Action Buttons -->
            <div class="action-buttons">
                <a href="{{ url_for('index') }}" class="btn btn-primary">
                    Process Another Claim
                </a>
                <button class="btn btn-secondary" onclick="window.print()">
                    Print Results
                </button>
                {% if claim.claim_status == 'review' %}
                <button class="btn btn-warning">
                    Request Manual Review
                </button>
                {% endif %}
            </div>

            {% else %}
            <!-- No Claim Data -->
            <div class="alert alert-error">
                <h3>No Claim Data Found</h3>
                <p>The requested claim could not be found or has not been processed yet.</p>
                <a href="{{ url_for('index') }}" class="btn btn-primary mt-4">
                    Return to Upload
                </a>
            </div>
            {% endif %}
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 OCR Claim Assessment System. Built with advanced AI technology for accurate document processing.</p>
        </div>
    </footer>

    <!-- JavaScript -->
    <script>
        function copyText() {
            const textElement = document.getElementById('extractedText');
            const copyBtn = document.getElementById('copyBtn');
            
            if (textElement) {
                // Create a temporary textarea to copy the text
                const textarea = document.createElement('textarea');
                textarea.value = textElement.textContent;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                
                // Show feedback
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'Copied!';
                copyBtn.classList.add('btn-success');
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('btn-success');
                }, 2000);
            }
        }

        // Auto-refresh for processing claims
        {% if claim and claim.claim_status == 'processing' %}
        setTimeout(() => {
            location.reload();
        }, 5000); // Refresh every 5 seconds for processing claims
        {% endif %}

        // Print styles
        function addPrintStyles() {
            const style = document.createElement('style');
            style.textContent = `
                @media print {
                    .action-buttons, 
                    .btn,
                    header nav,
                    footer {
                        display: none !important;
                    }
                    
                    .container {
                        max-width: none !important;
                        padding: 0 !important;
                    }
                    
                    .claim-result {
                        break-inside: avoid;
                        margin-bottom: 20px;
                    }
                    
                    .extracted-text-content {
                        max-height: none !important;
                        overflow: visible !important;
                        font-size: 10pt;
                        line-height: 1.2;
                    }
                }
            `;
            document.head.appendChild(style);
        }

        // Initialize print styles
        addPrintStyles();

        // Smooth scroll for any anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth'
                    });
                }
            });
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Results page loaded');
            
            // Add fade-in animation to cards
            const cards = document.querySelectorAll('.claim-result, .card');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('fade-in');
                }, index * 100);
            });
        });
    </script>
</body>
</html>