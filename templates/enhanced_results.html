<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Claim Processing Results - OCR System</title>
    
    <!-- Custom CSS (matching your existing design system) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">
    
</head>

<body>
    <header>
        <div class="container">
            <div class="header-content">
                <a href="{{ url_for('index') }}" class="logo">OCR Claim Assessment</a>
                <nav>
                    <ul class="nav-links">
                        <li><a href="{{ url_for('index') }}">Upload New</a></li>
                        <li><a href="#" onclick="window.print()">Print Results</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main>
        <div class="container enhanced-results-container">
            <div class="page-title">
                <h1>Enhanced AI Processing Results</h1>
                <p class="page-subtitle">Comprehensive analysis with AI-powered insights</p>
            </div>

            <!-- Workflow Progress -->
            <div class="workflow-progress">
                <h3 class="workflow-title">
                    <span>AI Processing Workflow</span>
                    <span class="ai-badge">10-Step Pipeline</span>
                </h3>
                
                {% if result.workflow_steps %}
                    {% for step in result.workflow_steps %}
                    <div class="workflow-step">
                        <div class="step-indicator {{ step.status }}">
                            {% if step.status == 'completed' %}✓
                            {% elif step.status == 'failed' %}✗
                            {% elif step.status == 'skipped' %}−
                            {% elif step.status == 'in_progress' %}⋯
                            {% else %}{{ loop.index }}
                            {% endif %}
                        </div>
                        <div class="step-content">
                            <div class="step-name">{{ step.step_name|title|replace('_', ' ') }}</div>
                            <div class="step-description">{{ step.output_summary or 'Processing step' }}</div>
                            {% if step.duration_ms %}
                            <div class="step-time">Completed in {{ "%.2f"|format(step.duration_ms / 1000) }}s</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="alert alert-info">
                    No detailed workflow information available. This may be due to enhanced processing not being fully completed.
                </div>
                {% endif %}
            </div>

            <!-- AI Analysis Results Grid -->
            <div class="ai-results-grid">
                <!-- Document Classification -->
                {% if result.document_classification %}
                <div class="ai-result-card">
                    <div class="ai-result-header">
                        <h4 class="ai-result-title">Document Classification</h4>
                        <span class="ai-badge">AI Powered</span>
                    </div>
                    
                    <div class="detail-item">
                        <div class="field-label">Document Type</div>
                        <div class="field-value">{{ result.document_classification.document_type|title }}</div>
                    </div>
                    
                    <div class="confidence-display">
                        <div class="confidence-label">Classification Confidence</div>
                        <div class="confidence-bar-container">
                            <div class="confidence-fill confidence-{{ 'excellent' if result.document_classification.confidence >= 0.9 else 'good' if result.document_classification.confidence >= 0.7 else 'fair' if result.document_classification.confidence >= 0.5 else 'poor' }}" 
                                 style="width: {{ (result.document_classification.confidence * 100)|round }}%"></div>
                        </div>
                        <div class="confidence-text">{{ (result.document_classification.confidence * 100)|round }}%</div>
                    </div>
                    
                    {% if result.document_classification.features_detected %}
                    <div class="detail-item mt-3">
                        <div class="field-label">Key Features Detected</div>
                        <div class="field-value">
                            {% for feature in result.document_classification.features_detected[:3] %}
                                <span class="badge badge-secondary me-1">{{ feature }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Quality Assessment -->
                {% if result.quality_assessment %}
                <div class="ai-result-card">
                    <div class="ai-result-header">
                        <h4 class="ai-result-title">Quality Assessment</h4>
                        <span class="ai-badge">Computer Vision</span>
                    </div>
                    
                    <div class="confidence-display">
                        <div class="confidence-label">Overall Quality Score</div>
                        <div class="confidence-bar-container">
                            <div class="confidence-fill confidence-{{ 'excellent' if result.quality_assessment.quality_score.overall_score >= 0.9 else 'good' if result.quality_assessment.quality_score.overall_score >= 0.7 else 'fair' if result.quality_assessment.quality_score.overall_score >= 0.5 else 'poor' }}" 
                                 style="width: {{ (result.quality_assessment.quality_score.overall_score * 100)|round }}%"></div>
                        </div>
                        <div class="confidence-text">{{ (result.quality_assessment.quality_score.overall_score * 100)|round }}%</div>
                    </div>
                    
                    <div class="quality-metrics">
                        {% if result.quality_assessment.quality_score.readability_score %}
                        <div class="quality-metric">
                            <div class="quality-metric-value">{{ (result.quality_assessment.quality_score.readability_score * 100)|round }}%</div>
                            <div class="quality-metric-label">Readability</div>
                        </div>
                        {% endif %}
                        
                        {% if result.quality_assessment.quality_score.clarity_score %}
                        <div class="quality-metric">
                            <div class="quality-metric-value">{{ (result.quality_assessment.quality_score.clarity_score * 100)|round }}%</div>
                            <div class="quality-metric-label">Clarity</div>
                        </div>
                        {% endif %}
                        
                        {% if result.quality_assessment.quality_score.completeness_score %}
                        <div class="quality-metric">
                            <div class="quality-metric-value">{{ (result.quality_assessment.quality_score.completeness_score * 100)|round }}%</div>
                            <div class="quality-metric-label">Completeness</div>
                        </div>
                        {% endif %}
                    </div>
                    
                    {% if result.quality_assessment.is_acceptable %}
                    <div class="alert alert-success">
                        <strong>Quality Status:</strong> Document meets quality standards for processing
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <strong>Quality Status:</strong> Document quality may affect processing accuracy
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Extracted Data -->
                {% if result.extracted_data %}
                <div class="ai-result-card">
                    <div class="ai-result-header">
                        <h4 class="ai-result-title">Extracted Data</h4>
                        <span class="ai-badge">Smart Extraction</span>
                    </div>
                    
                    <div class="extracted-data-grid">
                        {% for key, value in result.extracted_data.items() %}
                        <div class="extracted-field">
                            <div class="field-label">{{ key|replace('_', ' ')|title }}</div>
                            <div class="field-value">{{ value }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Fraud Detection -->
                {% if result.fraud_findings is defined %}
                <div class="ai-result-card">
                    <div class="ai-result-header">
                        <h4 class="ai-result-title">Fraud Detection</h4>
                        <span class="ai-badge">Security Analysis</span>
                    </div>
                    
                    {% if result.fraud_findings|length > 0 %}
                    <div class="alert alert-warning">
                        <strong>Findings Detected:</strong>
                        <ul class="mt-2 mb-0">
                            {% for finding in result.fraud_findings %}
                            <li>{{ finding }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% else %}
                    <div class="alert alert-success">
                        <strong>No suspicious patterns detected</strong>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <!-- Decision Summary -->
            <div class="decision-summary {{ result.status }}">
                <div class="decision-header">
                    <h3>Processing Decision</h3>
                    <div class="decision-status {{ result.status }}">
                        {% if result.status == 'approved' %}✓ Approved
                        {% elif result.status == 'rejected' %}✗ Rejected  
                        {% elif result.status == 'review' %}⚠ Requires Review
                        {% else %}{{ result.status|title }}
                        {% endif %}
                    </div>
                </div>
                
                <div class="confidence-display">
                    <div class="confidence-label">Decision Confidence</div>
                    <div class="confidence-bar-container">
                        <div class="confidence-fill confidence-{{ 'excellent' if result.confidence >= 0.9 else 'good' if result.confidence >= 0.7 else 'fair' if result.confidence >= 0.5 else 'poor' }}" 
                             style="width: {{ (result.confidence * 100)|round }}%"></div>
                    </div>
                    <div class="confidence-text">{{ (result.confidence * 100)|round }}%</div>
                </div>
                
                {% if result.decision_reasons %}
                <div class="decision-reasons">
                    <h5>Decision Factors:</h5>
                    {% for reason in result.decision_reasons %}
                    <div class="reason-item">{{ reason }}</div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="detail-item">
                    <div class="field-label">Processing Time</div>
                    <div class="field-value">{{ "%.2f"|format(result.processing_time_ms / 1000) }} seconds</div>
                </div>
            </div>

            <!-- Original OCR Text -->
            {% if result.ocr_text %}
            <div class="extracted-text">
                <h4 class="extracted-text-title">
                    <span>Original OCR Text</span>
                    <span class="ai-badge">{{ result.ai_engines_used[0] if result.ai_engines_used else 'Mistral' }} OCR</span>
                </h4>
                <div class="extracted-text-content">{{ result.ocr_text }}</div>
            </div>
            {% endif %}

            <!-- Debug Information (remove in production) -->
            {% if not result.enhanced_data_available %}
            <div class="alert alert-warning">
                <strong>Debug Information:</strong>
                Enhanced processing data is not available. This could be due to:
                <ul>
                    <li>Processing still in progress</li>
                    <li>Enhanced processor not initialized properly</li>
                    <li>Data structure mismatch</li>
                </ul>
                <small>Enhanced data available: {{ result.enhanced_data_available }}</small>
            </div>
            {% endif %}

            <!-- Action Buttons -->
            <div class="action-buttons">
                <a href="{{ url_for('index') }}" class="btn btn-primary">Process Another Document</a>
                <button onclick="window.print()" class="btn btn-secondary">Print Results</button>
                <button onclick="downloadResults()" class="btn btn-secondary">Download JSON</button>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 OCR Claim Assessment System. Enhanced with AI-powered analysis.</p>
        </div>
    </footer>

    <script>
        function downloadResults() {
            const results = {{ result|tojson|safe }};
            const blob = new Blob([JSON.stringify(results, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'claim-analysis-results.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>