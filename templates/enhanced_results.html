<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Claim Processing Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .workflow-step {
            margin-bottom: 1rem;
            border-left: 4px solid #dee2e6;
            padding-left: 1rem;
        }
        .workflow-step.completed {
            border-left-color: #28a745;
        }
        .workflow-step.failed {
            border-left-color: #dc3545;
        }
        .workflow-step.skipped {
            border-left-color: #ffc107;
        }
        .workflow-step.in_progress {
            border-left-color: #007bff;
        }
        .confidence-bar {
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        .confidence-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        .confidence-excellent { background-color: #28a745; }
        .confidence-good { background-color: #20c997; }
        .confidence-fair { background-color: #ffc107; }
        .confidence-poor { background-color: #fd7e14; }
        .confidence-bad { background-color: #dc3545; }
        .ai-badge {
            font-size: 0.8em;
            padding: 0.25rem 0.5rem;
        }
        .quality-metric {
            padding: 0.5rem;
            margin: 0.25rem 0;
            border-radius: 0.375rem;
            background-color: #f8f9fa;
        }
        .extracted-field {
            background-color: #e7f3ff;
            padding: 0.5rem;
            margin: 0.25rem 0;
            border-radius: 0.375rem;
            border-left: 3px solid #0066cc;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3">
                        <i class="bi bi-file-medical"></i>
                        Enhanced Claim Analysis
                    </h1>
                    <a href="/" class="btn btn-outline-primary">
                        <i class="bi bi-arrow-left"></i> Process Another Claim
                    </a>
                </div>

                <!-- Alert for claim status -->
                {% if claim.claim_status == 'approved' %}
                <div class="alert alert-success" role="alert">
                    <i class="bi bi-check-circle-fill"></i>
                    <strong>Claim Approved!</strong> This claim has been automatically approved by our AI system.
                </div>
                {% elif claim.claim_status == 'rejected' %}
                <div class="alert alert-danger" role="alert">
                    <i class="bi bi-x-circle-fill"></i>
                    <strong>Claim Rejected.</strong> This claim did not meet approval criteria.
                </div>
                {% elif claim.claim_status == 'review' %}
                <div class="alert alert-warning" role="alert">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>Manual Review Required.</strong> This claim requires human review.
                </div>
                {% endif %}

                <div class="row">
                    <!-- Main Results Column -->
                    <div class="col-md-8">
                        <!-- Claim Summary -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-clipboard-data"></i>
                                    Claim Summary
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Claim ID:</strong> {{ claim.id }}</p>
                                        <p><strong>Status:</strong> 
                                            <span class="badge bg-{% if claim.claim_status == 'approved' %}success{% elif claim.claim_status == 'rejected' %}danger{% else %}warning{% endif %}">
                                                {{ claim.claim_status.title() }}
                                            </span>
                                        </p>
                                        <p><strong>Amount:</strong> ${{ "%.2f"|format(claim.claim_amount or 0) }}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Confidence Score:</strong></p>
                                        <div class="confidence-bar mb-2">
                                            <div class="confidence-fill confidence-{% if claim.confidence_score >= 0.9 %}excellent{% elif claim.confidence_score >= 0.7 %}good{% elif claim.confidence_score >= 0.5 %}fair{% elif claim.confidence_score >= 0.3 %}poor{% else %}bad{% endif %}" 
                                                 style="width: {{ (claim.confidence_score * 100)|round }}%"></div>
                                        </div>
                                        <small class="text-muted">{{ (claim.confidence_score * 100)|round }}% confidence</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- AI Workflow Progress -->
                        {% if enhanced_data and enhanced_data.workflow_steps %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-diagram-3"></i>
                                    AI Processing Workflow
                                </h5>
                            </div>
                            <div class="card-body">
                                {% for step in enhanced_data.workflow_steps %}
                                <div class="workflow-step {{ step.status }}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1">
                                                {% if step.status == 'completed' %}<i class="bi bi-check-circle-fill text-success"></i>
                                                {% elif step.status == 'failed' %}<i class="bi bi-x-circle-fill text-danger"></i>
                                                {% elif step.status == 'skipped' %}<i class="bi bi-dash-circle-fill text-warning"></i>
                                                {% else %}<i class="bi bi-arrow-right-circle-fill text-primary"></i>
                                                {% endif %}
                                                {{ step.step_name.replace('_', ' ').title() }}
                                                {% if step.ai_engine_used %}
                                                <span class="badge bg-info ai-badge">{{ step.ai_engine_used }}</span>
                                                {% endif %}
                                            </h6>
                                            {% if step.output_summary %}
                                            <p class="mb-1 text-muted">{{ step.output_summary }}</p>
                                            {% endif %}
                                        </div>
                                        <div class="text-end">
                                            {% if step.confidence_score %}
                                            <small class="text-muted">{{ (step.confidence_score * 100)|round }}%</small>
                                            {% endif %}
                                            {% if step.duration_ms %}
                                            <br><small class="text-muted">{{ step.duration_ms }}ms</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if step.issues_found %}
                                    <div class="mt-2">
                                        {% for issue in step.issues_found %}
                                        <small class="badge bg-warning me-1">{{ issue }}</small>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Extracted Data -->
                        {% if enhanced_data and enhanced_data.extracted_data %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-file-text"></i>
                                    Extracted Information
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    {% set extracted = enhanced_data.extracted_data %}
                                    {% if extracted.patient_name %}
                                    <div class="col-md-6">
                                        <div class="extracted-field">
                                            <strong>Patient Name:</strong> {{ extracted.patient_name }}
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if extracted.patient_id %}
                                    <div class="col-md-6">
                                        <div class="extracted-field">
                                            <strong>Patient ID:</strong> {{ extracted.patient_id }}
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if extracted.policy_number %}
                                    <div class="col-md-6">
                                        <div class="extracted-field">
                                            <strong>Policy Number:</strong> {{ extracted.policy_number }}
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if extracted.provider_name %}
                                    <div class="col-md-6">
                                        <div class="extracted-field">
                                            <strong>Provider:</strong> {{ extracted.provider_name }}
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if extracted.total_amount %}
                                    <div class="col-md-6">
                                        <div class="extracted-field">
                                            <strong>Amount:</strong> {{ extracted.currency }} ${{ "%.2f"|format(extracted.total_amount) }}
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if extracted.treatment_dates %}
                                    <div class="col-md-6">
                                        <div class="extracted-field">
                                            <strong>Treatment Dates:</strong> 
                                            {% for date in extracted.treatment_dates %}
                                                <span class="badge bg-secondary">{{ date }}</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if extracted.diagnosis_codes %}
                                    <div class="col-md-12">
                                        <div class="extracted-field">
                                            <strong>Diagnosis Codes:</strong> 
                                            {% for code in extracted.diagnosis_codes %}
                                                <span class="badge bg-info">{{ code }}</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Decision Reasoning -->
                        {% if enhanced_data and enhanced_data.reasons %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-lightbulb"></i>
                                    Decision Reasoning
                                </h5>
                            </div>
                            <div class="card-body">
                                <ul class="list-unstyled">
                                    {% for reason in enhanced_data.reasons %}
                                    <li class="mb-2">
                                        <i class="bi bi-arrow-right text-primary"></i>
                                        {{ reason }}
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% if enhanced_data.processing_notes %}
                                <div class="mt-3 p-3 bg-light rounded">
                                    <strong>Processing Notes:</strong> {{ enhanced_data.processing_notes }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Sidebar with AI Analysis -->
                    <div class="col-md-4">
                        <!-- Document Classification -->
                        {% if enhanced_data and enhanced_data.document_classification %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-tags"></i>
                                    Document Classification
                                </h6>
                            </div>
                            <div class="card-body">
                                {% set doc_class = enhanced_data.document_classification %}
                                <p><strong>Type:</strong> 
                                    <span class="badge bg-primary">{{ doc_class.document_type.replace('_', ' ').title() }}</span>
                                </p>
                                <p><strong>Confidence:</strong> {{ (doc_class.confidence * 100)|round }}%</p>
                                
                                <div class="confidence-bar mb-3">
                                    <div class="confidence-fill confidence-{% if doc_class.confidence >= 0.9 %}excellent{% elif doc_class.confidence >= 0.7 %}good{% elif doc_class.confidence >= 0.5 %}fair{% elif doc_class.confidence >= 0.3 %}poor{% else %}bad{% endif %}" 
                                         style="width: {{ (doc_class.confidence * 100)|round }}%"></div>
                                </div>
                                
                                {% if doc_class.reasoning %}
                                <small><strong>Reasoning:</strong></small>
                                <ul class="small mt-2 mb-0">
                                    {% for reason in doc_class.reasoning[:3] %}
                                    <li>{{ reason }}</li>
                                    {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Quality Assessment -->
                        {% if enhanced_data and enhanced_data.quality_assessment %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-shield-check"></i>
                                    Quality Assessment
                                </h6>
                            </div>
                            <div class="card-body">
                                {% set quality = enhanced_data.quality_assessment %}
                                {% set scores = quality.quality_score %}
                                
                                <div class="quality-metric">
                                    <strong>Overall:</strong> {{ (scores.overall_score * 100)|round }}%
                                    <div class="confidence-bar mt-1">
                                        <div class="confidence-fill confidence-{% if scores.overall_score >= 0.8 %}excellent{% elif scores.overall_score >= 0.6 %}good{% elif scores.overall_score >= 0.4 %}fair{% else %}poor{% endif %}" 
                                             style="width: {{ (scores.overall_score * 100)|round }}%"></div>
                                    </div>
                                </div>
                                
                                <div class="quality-metric">
                                    <small><strong>Readability:</strong> {{ (scores.readability_score * 100)|round }}%</small>
                                </div>
                                <div class="quality-metric">
                                    <small><strong>Clarity:</strong> {{ (scores.clarity_score * 100)|round }}%</small>
                                </div>
                                <div class="quality-metric">
                                    <small><strong>Completeness:</strong> {{ (scores.completeness_score * 100)|round }}%</small>
                                </div>
                                
                                {% if quality.issues_detected %}
                                <div class="mt-3">
                                    <small><strong>Issues Detected:</strong></small>
                                    {% for issue in quality.issues_detected %}
                                    <br><small class="badge bg-warning">{{ issue.replace('_', ' ').title() }}</small>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Processing Statistics -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-graph-up"></i>
                                    Processing Stats
                                </h6>
                            </div>
                            <div class="card-body">
                                <p><small><strong>File Size:</strong> {{ (claim.file_size / 1024)|round(1) }} KB</small></p>
                                <p><small><strong>Processing Time:</strong> 
                                    {% if enhanced_data and enhanced_data.total_processing_time_ms %}
                                        {{ enhanced_data.total_processing_time_ms }}ms
                                    {% else %}
                                        {{ claim.metadata.processing_time_ms or 0 }}ms
                                    {% endif %}
                                </small></p>
                                <p><small><strong>Language Detected:</strong> {{ claim.language_detected or 'English' }}</small></p>
                                {% if enhanced_data and enhanced_data.ai_engines_used %}
                                <p><small><strong>AI Engines Used:</strong></small></p>
                                {% for engine in enhanced_data.ai_engines_used %}
                                    {% if engine %}
                                    <span class="badge bg-info ai-badge">{{ engine }}</span>
                                    {% endif %}
                                {% endfor %}
                                {% endif %}
                            </div>
                        </div>

                        <!-- OCR Text Preview -->
                        {% if ocr and ocr.extracted_text %}
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-file-text"></i>
                                    Extracted Text Preview
                                </h6>
                            </div>
                            <div class="card-body">
                                <div style="max-height: 200px; overflow-y: auto;">
                                    <small class="text-muted">{{ ocr.extracted_text[:500] }}{% if ocr.extracted_text|length > 500 %}...{% endif %}</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>